services:
  genscene-backend:
    build: .
    container_name: genscene-backend
    ports:
      - "8000:8000"
    volumes:
      - genscene_data:/app/data
      - genscene_media:/app/media
    environment:
      # Core Settings
      - BACKEND_BASE_URL=${BACKEND_BASE_URL:-http://localhost:8000}
      - MEDIA_DIR=/app/media
      - DATABASE_URL=sqlite:///./data/genscene.db
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Security
      - BACKEND_API_KEY=${BACKEND_API_KEY:-genscene_api_key_prod_2025_secure}
      - CORS_ALLOW_ORIGINS=${CORS_ALLOW_ORIGINS:-*}
      - RATE_LIMIT_RPM=${RATE_LIMIT_RPM:-60}

      # Worker Configuration
      - WORKER_CONCURRENCY=${WORKER_CONCURRENCY:-4}
      - WORKER_POLL_INTERVAL=${WORKER_POLL_INTERVAL:-2}

      # Video Settings (9:16 for Shorts)
      - COMPOSE_WIDTH=${COMPOSE_WIDTH:-720}
      - COMPOSE_HEIGHT=${COMPOSE_HEIGHT:-1280}
      - COMPOSE_FPS=${COMPOSE_FPS:-30}
      - COMPOSE_CRF=${COMPOSE_CRF:-23}
      - COMPOSE_PRESET=${COMPOSE_PRESET:-veryfast}

      # Kie.ai Integration
      - KIE_API_KEY=${KIE_API_KEY:-}
      - KIE_BASE_URL=${KIE_BASE_URL:-https://api.kie.ai}

      # Public URL for assets
      - PUBLIC_BASE_URL=${PUBLIC_BASE_URL:-http://localhost:8000}

    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  genscene_data:
    driver: local
  genscene_media:
    driver: local
