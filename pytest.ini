[tool:pytest]
# Pytest configuration for Gen Scene Studio Backend

# Test discovery
testpaths = tests
python_files = test_*.py *_test.py
python_classes = Test*
python_functions = test_*

# Output and reporting
addopts =
    --strict-markers
    --strict-config
    --verbose
    --tb=short
    --showlocals
    --durations=10
    --maxfail=5
    --color=yes
    --cov=src
    --cov-report=html:htmlcov/index.html
    --cov-report=xml:coverage.xml
    --cov-report=term-missing
    --cov-fail-under=80
    --benchmark-only
    --junit-xml=junit-report.xml

# Asyncio configuration
asyncio_mode = auto
asyncio_default_fixture_loop_scope = function

# Test markers
markers =
    unit: Unit tests (fast, isolated)
    integration: Integration tests (slower, realistic)
    e2e: End-to-end tests (slowest, full stack)
    performance: Performance and load tests (requires special setup)
    slow: Mark test as slow running (may be skipped in CI)
    database: Tests requiring database connection
    api: Tests requiring HTTP API
    migration: Migration system tests
    security: Security-related tests
    flaky: Mark test as potentially flaky
    skip_ci: Skip test in CI environment

# Minimum version requirements
minversion = 7.0
required_plugins =
    pytest-asyncio>=0.21.0
    pytest-cov>=4.0.0
    pytest-benchmark>=4.0.0

# Logging
log_cli = true
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

# Test session configuration
timeout = 300  # 5 minutes default timeout
timeout_method = thread  # Use thread-based timeout

# Console output
console_output_style = progress
console_output_style_logging = modern

# Warnings
filterwarnings =
    ignore::UserWarning
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning
    default:::Warning

# Coverage measurement
[coverage:run]
source = src
omit =
    */tests/*
    */migrations/*
    */__pycache__/*
    */venv/*
    */virtualenv/*
    */.venv/*
    */site-packages/*
    */tests/conftest.py
    */tests/fixtures/*

branch = true
parallel = true
command_line = -m pytest

# Coverage HTML report
[coverage:html]
directory = htmlcov
title = Gen Scene Studio Backend Coverage Report
show_contexts = True
skip_covered = False
skip_empty = False
precision = 2

# Coverage XML report
[coverage:xml]
output = coverage.xml
skip_empty = True

# Benchmark configuration
[pytest-benchmark]
benchmark_min_rounds = 3
benchmark_timer = time.perf_counter
benchmark_sort = mean
benchmark_histogram = true
benchmark_save = data
benchmark_save_data = true
benchmark_disable_gc = true
benchmark_only = true
benchmark_min_time = 0.005  # 5ms minimum

# Performance test configuration
[pytest-xdist]
dist = load
loadscope = session

# Pre-commit hooks (if installed)
[pytest-watch]
patterns = src/**/*.py tests/**/*.py
ignore_patterns = __pycache__ .venv .tox
runner = python -m pytest