name: Deploy to Production

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # Deploy Frontend to Vercel
  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_API_KEY: ${{ secrets.VITE_API_KEY }}

      - name: Deploy to Vercel
        uses: vercel/action@v1
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./frontend
          vercel-args: '--prod'

  # Deploy Backend to Production Server
  deploy-backend:
    runs-on: ubuntu-latest
    needs: deploy-frontend
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install SSH tools
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass rsync

      - name: Deploy backend files
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          # Copiar archivos del backend al servidor
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -r whatif-backend/* $SSH_USER@$SSH_HOST:/opt/genscene-backend/

          # Copiar archivos frontend estÃ¡ticos (si aplica)
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -r frontend/dist/* $SSH_USER@$SSH_HOST:/var/www/html/ 2>/dev/null || true

          # Reiniciar el backend
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "cd /opt/genscene-backend && docker compose restart genscene-backend"

      - name: Health check
        run: |
          sleep 10
          curl -f ${{ secrets.API_URL }}/health || exit 1

  # Notify deployment success
  notify:
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: success()
    steps:
      - name: Send notification
        run: |
          echo "ðŸš€ Deployment completed successfully!"
          echo "Frontend: https://genscenestudio.com"
          echo "Backend: ${{ secrets.API_URL }}"